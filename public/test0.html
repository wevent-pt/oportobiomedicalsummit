<!DOCTYPE html>
<html>

<head>
  <title>Ticketing Form</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* global styles */
    :root {
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --input-bg-color: #243445;
      --input-focus-bg-color: #243445;
      --button-bg-color: #b95f4d;
      --button-hover-bg-color: #2F2F2F;
    }

    /* Global Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background-color: #d4dfec;
    }

    h1 {
      font-size: 30px;
      text-align: center;
      margin-top: 10px;
      margin-bottom: 10px;
      color: #243445;
      text-shadow: 1px 1px #C87766;
    }

    form {
      max-width: 70vw;
      margin: 0 auto;
      padding: 10px;
      background-color: #c8d5e27d;
      border-radius: 10px;
      display: flex;
      flex-direction: row;
      align-content: center;
      align-items: center;
      grid-template-columns: max-content !important;
      grid-gap: 5px;
      flex-wrap: wrap;
      justify-content: space-evenly;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
      color: #243445;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: var(--input-bg-color);
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
      color: #fff;
    }

    select:focus,
    input[type="email"]:focus {
      outline: none;
      box-shadow: 0 0 5px #C87766;
      background-color: var(--input-focus-bg-color);
    }

    input[type="email"] {
      width: 100%;
      padding: 5px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: var(--input-bg-color);
      margin-bottom: 10px;
      transition: background-color 0.3s ease;
      color: #fff;
    }

    select:focus,
    input[type="email"]:focus {
      outline: none;
      box-shadow: 0 0 5px #C87766;
      background-color: var(--input-focus-bg-color);
    }

    .personal-info-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      grid-gap: 30px;
    }

    .personal-info-section div {
      grid-column: span 2;
    }

    .personal-info-section input[type="text"] {
      width: 100%;
    }

    .submit-button {
      background-color: var(--button-bg-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .submit-button:hover {
      background-color: var(--button-hover-bg-color);
    }

    /* Media Queries */
    @media screen and (max-width: 1024px) {
      form {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }
    }

    @media screen and (max-width: 768px) {
      h1 {
        font-size: 36px;
      }

      form {
        max-width: 80vw;
      }
    }

    #total {
      color: #fff
    }

    #submit-button {
      background-color: #C87766;
      /* Green */
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 5px;
    }

    #total-checkoutbtn_wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border: 1px solid #c87766;
      border-radius: 5px;
    }

    #total-checkoutbtn_wrapper label {
      font-size: 1.2rem;
    }

    /* #total-checkoutbtn_wrapper span {
  font-size: 1.2rem;
  font-weight: bold;
  margin: 10px;
  border: 2px solid #fff;
  background: linear-gradient(to right, #6dd5ed, #2193b0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
} */

    #total-checkoutbtn_wrapper span {
      font-size: 1.2rem;
      font-weight: bold;
      margin: 10px;
      animation: pulse 2s infinite;
      text-shadow: 0 0 10px #C87766;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.1);
      }

      100% {
        transform: scale(1);
      }
    }

  </style>
</head>

<body>
  <h1>Ticketing Form</h1>
  <form id="ticket-form">
    <div>
      <label for="ticket-bird">Ticket Bird:</label>
      <select id="ticket-bird">
        <option value="Early Bird">Early Bird</option>
        <option value="Late Bird" disabled>Late Bird</option>
      </select>

      <label for="ticket-type">Ticket Type:</label>
      <select id="ticket-type">
        <option value="Full Ticket">Full Ticket</option>
        <option value="Partial Ticket">Partial Ticket</option>
      </select>
      <label for="participant-type">Participant Type:</label>
      <select id="participant-type">
        <option value="ICBAS Student">ICBAS Student</option>
        <option value="Non-ICBAS Student">Non-ICBAS Student</option>
        <option value="Non-Student">Non-Student</option>
      </select>
      <label for="ambassador-code">
        Ambassador Code (optional):
      </label>
      <input type="text" id="ambassador-code" aria-label="Ambassador Code" />
      <label for="coupon-code">
        Coupon Code (optional):
      </label>
      <input type="text" id="coupon-code" aria-label="Coupon Code" />
      <div id="coupon-error"></div>
    </div>

    <div id="form-fields">
      <!-- Form fields will be generated dynamically -->
    </div>
    <div id='total-checkoutbtn_wrapper'>

      <br><br>

      <label for="total">Total:</label>
      <span id="total"></span>
      <button type="button" id="submit-button">Payment</button>

      <br><br>
    </div>
  </form>

  <script>
    // Your JavaScript code goes here
    const commonRequiredInfo = ["Full Name", "Email", "Phone Number"];
    const commonCoupons = ["100OFF"];
    const tickets = {
      "Early Bird": {
        "Full Ticket": {
          "ICBAS Student": {
            price: 35.5,
            coupons: [...commonCoupons, "ICBASPROMOFULL"],
            requiredInfo: [...commonRequiredInfo, "Student Number", "Academic Year"]
          },
          "Non-ICBAS Student": {
            price: 38.5,
            coupons: commonCoupons,
            requiredInfo: [
              ...commonRequiredInfo,
              "Faculty/University",
              "Academic Year"
            ]
          }
        },
        "Partial Ticket": {
          "ICBAS Student": {
            price: 15.5,
            coupons: [...commonCoupons, "ICBASPROMOPARTIAL"],
            requiredInfo: [...commonRequiredInfo, "Student Number", "Academic Year"]
          },
          "Non-ICBAS Student": {
            price: 18.5,
            coupons: commonCoupons,
            requiredInfo: [
              ...commonRequiredInfo,
              "University or School",
              "Year of Studies"
            ]
          },
          "Non-Student": {
            price: 39.5,
            coupons: commonCoupons,
            requiredInfo: commonRequiredInfo
          }
        }
      },
      "Late Bird": {
        "Full Ticket": {
          "ICBAS Student": {
            price: 38.5,
            coupons: [...commonCoupons, "ICBASPROMOFULL"],
            requiredInfo: [...commonRequiredInfo, "Student Number", "Academic Year"]
          },
          "Non-ICBAS Student": {
            price: 41.5,
            coupons: commonCoupons,
            requiredInfo: [
              ...commonRequiredInfo,
              "University",
              "Faculty",
              "Academic Year"
            ]
          }
        },
        "Partial Ticket": {
          "ICBAS Student": {
            price: 18.5,
            coupons: [...commonCoupons, "ICBASPROMOPARTIAL"],
            requiredInfo: [...commonRequiredInfo, "Student Number", "Academic Year"]
          },
          "Non-ICBAS Student": {
            price: 21.5,
            coupons: commonCoupons,
            requiredInfo: [
              ...commonRequiredInfo,
              "University",
              "Faculty",
              "Year of Studies"
            ]
          },
          "Non-Student": {
            price: 42.5,
            coupons: commonCoupons,
            requiredInfo: commonRequiredInfo
          }
        }
      }
    };
    const updateTotal = (price) => {
      // const couponCode = document.getElementById("coupon-code").value;
      // const couponResult = applyCoupon(couponCode, price);

      // var discountedPrice = couponResult.discount;
      // if (price === -1) {

      //   discountedPrice = -1
        // return -1;
        // // document.getElementById("coupon-error").textContent = "Invalid";
        // // document.getElementById("total").textContent = "invalid";
      // } else {
      //   document.getElementById("coupon-error").textContent = "";
      //   if (couponResult.isValid) {
      //     discountedPrice = couponResult.discount;
          document.getElementById("total").textContent = price.toFixed(2);
      //   } else {
      //     discountedPrice = -1
      //     document.getElementById("coupon-error").textContent = "Invalid coupon code";
      //     return -1;
      //   }
      // }
      return price;
    };
    const applyCoupon = (couponCode, price) => {
      const couponMapping = {
        "100OFF": 0,
        "ICBASPROMOFULL": 200,
        "ICBASPROMOPARTIAL": 300
      };
      if (couponCode) {
        if (couponMapping.hasOwnProperty(couponCode)) {
          const discount = couponMapping[couponCode];
          return {
            isValid: true,
            discount
          };
        } else {
          return {
            isValid: false
          };
        }
      } else {
        return {
          isValid: true,
          discount: price
        };
      }
    };
    const generateFormFields = (requiredInfo) => {
      let formFields = "";
      const userEmail = localStorage.getItem('userEmail') || 'Please Sign In';
      requiredInfo.forEach((info) => {
        if (info === 'Academic Year') {
          formFields += '<div>' +
          '<label for="' + info + '">' +
          info + ':' +
          '</label>' +
          '<select id="' + info + '" required aria-label="' + info + '">' +
          '<option value="1st year">1st year</option>' +
          '<option value="2nd year">2nd year</option>' +
          '<option value="3rd year">3rd year</option>' +
          '<option value="4th year">4th year</option>' +
          '<option value="5th year">5th year</option>' +
          '<option value="6th year">6th year</option>' +
          '</select>' +
          '</div>';

        } else if (userEmail && info === 'Email') {
  formFields += '<div>' +
    '<label for="' + info + '">' +
    info + ':' +
    '</label>' +
    '<input type="email" id="' + info + '" required aria-label="' + info + '" readonly="readonly" value="' + userEmail + '"></input>' +
    '</div>';
} else {
      formFields += '<div>' +
    '<label for="' + info + '">' +
    info + ':' +
    '</label>' +
    '<input type="text" id="' + info + '" required aria-label="' + info + '" />' +
    '</div>';
}

        
      });
      return formFields;
    };


      const updateFormFields = () => {
        const ticketType = document.getElementById("ticket-bird");
        const formOfTicket = document.getElementById("ticket-type");
        const participantType = document.getElementById("participant-type");
        // Check that required form elements exist

        if (!ticketType || !formOfTicket || !participantType) {
          console.error("Error: Required form elements not found");
          return;
        }
        const ticketTypeValue = ticketType.value;
        const formOfTicketValue = formOfTicket.value;
        const participantTypeValue = participantType.value;
        if (formOfTicketValue === 'Full Ticket' || participantTypeValue === 'Non-Student') {
          if (formOfTicketValue === 'Full Ticket' && participantTypeValue === 'Non-Student') {
            alert("Ticket Not available")
            console.log("Ticket Not available", ticketTypeValue, formOfTicketValue, participantTypeValue)
            //mudar seleção pq nãoe possivel
          }else if(formOfTicketValue === 'Full Ticket'){
            console.log(ticketTypeValue, formOfTicketValue, participantTypeValue)
            participantType.attributes[0].ownerElement[2].innerText = 'Non-Student*'
            formOfTicket.attributes[0].ownerElement[0].innerText = 'Full Ticket'
            //mudar seleção do non student disbled
          }else if(participantTypeValue === 'Non-Student'){
            console.log(ticketTypeValue, formOfTicketValue, participantTypeValue)
            formOfTicket.attributes[0].ownerElement[0].innerText = 'Full Ticket*'
            participantType.attributes[0].ownerElement[2].innerText = 'Non-Student'
            //mudar seleção do fullticketdisbled
          }else{
            participantType.attributes[0].ownerElement[2].innerText = 'Non-Student'
            formOfTicket.attributes[0].ownerElement[0].innerText = 'Full Ticket'
          }

        } else {
          //disponibilizar seleçoes
          
            // console.log(participantType.attributes,participantType.attributes[0].ownerElement[0].innerText)
          participantType.attributes[0].ownerElement[2].innerText = 'Non-Student'
            formOfTicket.attributes[0].ownerElement[0].innerText = 'Full Ticket'
        }
        // Check that entered values are valid
        if (!tickets[ticketTypeValue] || !tickets[ticketTypeValue][formOfTicketValue] || !tickets[ticketTypeValue][
            formOfTicketValue
          ][participantTypeValue]) {
          console.error("Error: Invalid form values entered");
          return;
        }
        const requiredInfo =
          tickets[ticketTypeValue][formOfTicketValue][participantTypeValue].requiredInfo;
        const formFields = generateFormFields(requiredInfo);
        document.getElementById("form-fields").innerHTML = formFields;
      };
      const checkFormFields = () => {
        const emailInForm = document.querySelectorAll("#form-fields #Email");
        console.log("check:::", emailInForm[0].validity.valid);
        let isFormValid = true;
        if (!emailInForm[0].validity.valid) {
          isFormValid = false;
        }

        const requiredFields = document.querySelectorAll("#form-fields input[required]");
        requiredFields.forEach((field) => {
          if (field.value.trim() === "") {
            isFormValid = false;
            // updateTotal(-1);
          }
        });
        return isFormValid;
      };
      const calculateTotal = () => {
        try {
          const ticketPrice = tickets[document.getElementById("ticket-bird").value][document.getElementById("ticket-type").value][document.getElementById("participant-type").value].price;
          console.log("ticketPrice", ticketPrice);
          updateTotal(ticketPrice);
          if (!checkFormFields()) {
            throw new Error("Please fill in all required form fields");
          }
        } catch (error) {
          console.error(error);
        }
      };

      
const submitForm = (event) => {
  event.preventDefault();
  // let metadata = {
  //   studentNumber: document.getElementById("Student Number")?.innerText,
  //   academicYear: document.getElementById("Academic Year")?.innerText,
  //   facultyUniversity: document.getElementById("Faculty/University")?.innerText,
  //   yearOfStudies: document.getElementById("Year of Studies")?.innerText,
  //   facultyUniversitySchool: document.getElementById("University or School")?.innerText,
  // }
    
  const endpoint = "/api/wevent/webhooks/submitTicketing";
  const body = JSON.stringify({
    action: "purchaseTicket",
    ticketId: Math.random().toString(36).substr(2, 6),
    ticketBird: document.getElementById("ticket-bird").value,
    ticketType: document.getElementById("ticket-type").value,
    participantType: document.getElementById("participant-type").value,
    ambassadorCode: document.getElementById("ambassador-code").value,
    couponCode: document.getElementById("coupon-code").value,
    name: document.getElementById("Full Name").value,
    email: document.getElementById("Email").value,
    phone: document.getElementById("Phone Number").value,
    metadata: {
      studentNumber: document.getElementById("Student Number")?.value || '',
      academicYear: document.getElementById("Academic Year")?.value,
      facultyUniversity: document.getElementById("Faculty/University")?.value,
      yearOfStudies: document.getElementById("Year of Studies")?.value,
      facultyUniversitySchool: document.getElementById("University or School")?.value,
    },
    paymentAmount: parseFloat(document.getElementById("total").innerText) * 100,
  });


  fetch(endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: body
  })
  .then(response => {
    if (!response.ok) throw new Error('Network response was not ok');
    return response.json();
  })
  .then(data => {
    top.location.href = data.sessionUrl;
  })
  .catch(error => {
    alert('Error submitting order. Please try again.');
    console.error(error);
  });
};


document.querySelectorAll("#ticket-bird, #ticket-type, #participant-type, #coupon-code").forEach(el => {
  el.addEventListener("change", () => {
    updateFormFields();
    calculateTotal();
  });
});

document.getElementById("submit-button").addEventListener("click", submitForm);


updateFormFields();
calculateTotal();



  </script>
</body>

</html>
